{"version":3,"sources":["Scheduler/Scheduler.js","resources/cursor_PNG99.png","Scheduler/getNewScheduledNotes.js","Scheduler/windowPosition.js","drumSynth.ts","App.tsx","index.tsx"],"names":["exports","__esModule","events_1","require","getNewScheduledNotes_1","Scheduler","this","loop","prevHorizon","emitter","EventEmitter","loopLength","prototype","setAudioContext","ac","setLoop","start","_this","timer","setInterval","iterate","emitSchedule","notes","emit","onSchedule","callback","on","_a","getNewScheduledNotes","currentTime","schedule","horizon","length","module","windowPosition_1","acTime","lookAhead","win","min","Math","max","rawPropWindow","translation","propWindow","map","note","pos","windowPosition","loopTime","data","audioContextTime","filter","Boolean","kick","audioContext","osc","createOscillator","osc2","gainOsc","createGain","gainOsc2","type","gain","setValueAtTime","exponentialRampToValueAtTime","frequency","connect","destination","stop","snare","osc3","gainOsc3","filterGain","value","node","createBufferSource","buffer","createBuffer","sampleRate","getChannelData","createBiquadFilter","linearRampToValueAtTime","i","random","hihat","gainOsc4","bandpass","highpass","forEach","ratio","osc4","serverURL","App","props","scheduler","user","floor","multiLane","React","createRef","subLoops","client","MessageClient","mousePosition","x","y","state","otherMouse","fn","onMessage","message","handleServerMessage","onConnected","reportMousePosition","resume","AudioContext","suspend","instr","broadcast","diff","getDiff","add","n","send","content","sequence","action","instrument","delete","concat","setState","change","newLoopTimes","orig","copy","slice","push","includes","applyDiff","current","setNotes","event","clientX","clientY","className","onMouseMove","handleMouseMove","userInfo","name","id","ref","onChange","handleNoteChange","onClick","startAudio","stopAudio","src","Cursor","alt","style","opacity","position","left","top","height","width","Component","prev","curr","ReactDOM","render","document","getElementById"],"mappings":"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","file":"static/js/main.f8f7dc1c.chunk.js","sourcesContent":["\"use strict\";\nexports.__esModule = true;\nvar events_1 = require(\"events\");\nvar getNewScheduledNotes_1 = require(\"./getNewScheduledNotes\");\nvar lookahead = 0.1;\nvar timerInterval = 25;\nvar Scheduler = /** @class */ (function () {\n    function Scheduler() {\n        this.loop = [];\n        this.prevHorizon = 0; // how far we looked ahead on the last iteration\n        this.emitter = new events_1.EventEmitter();\n        this.loopLength = 2; // seconds\n    }\n    Scheduler.prototype.setAudioContext = function (ac) {\n        this.ac = ac;\n    };\n    Scheduler.prototype.setLoop = function (loop) {\n        this.loop = loop;\n    };\n    Scheduler.prototype.start = function () {\n        var _this = this;\n        if (!this.timer) {\n            this.timer = setInterval(function () { return _this.iterate(); }, timerInterval);\n        }\n    };\n    Scheduler.prototype.emitSchedule = function (notes) {\n        this.emitter.emit('schedule', notes);\n    };\n    Scheduler.prototype.onSchedule = function (callback) {\n        this.emitter.on('schedule', callback);\n    };\n    Scheduler.prototype.iterate = function () {\n        var _a = getNewScheduledNotes_1.getNewScheduledNotes(this.loop, this.ac.currentTime, lookahead, this.prevHorizon, this.loopLength), schedule = _a.schedule, horizon = _a.horizon;\n        this.prevHorizon = horizon;\n        if (schedule.length > 0) {\n            this.emitSchedule(schedule);\n        }\n    };\n    return Scheduler;\n}());\nexports.Scheduler = Scheduler;\n","module.exports = __webpack_public_path__ + \"static/media/cursor_PNG99.be56600f.png\";","\"use strict\";\nexports.__esModule = true;\nvar windowPosition_1 = require(\"./windowPosition\");\nfunction getNewScheduledNotes(loop, acTime, lookAhead, prevHorizon, loopLength) {\n    var win = {\n        min: Math.max(acTime, prevHorizon),\n        max: acTime + lookAhead\n    };\n    // express range as number of loops\n    var rawPropWindow = { min: win.min / loopLength, max: win.max / loopLength };\n    // translate range so that min falls between 0 and 1\n    var translation = (rawPropWindow.min % 1) - rawPropWindow.min;\n    var propWindow = {\n        min: rawPropWindow.min + translation,\n        max: rawPropWindow.max + translation\n    };\n    var schedule = loop\n        .map(function (note) {\n        var pos = windowPosition_1.windowPosition(note.loopTime, propWindow);\n        if (!pos)\n            return null;\n        return {\n            data: note.data,\n            audioContextTime: (pos - translation) * loopLength\n        };\n    })\n        .filter(Boolean);\n    return {\n        schedule: schedule,\n        horizon: win.max\n    };\n}\nexports.getNewScheduledNotes = getNewScheduledNotes;\n","\"use strict\";\nexports.__esModule = true;\n/**\n *\n * @param loopTime\n * @param propWindow window expressed as prop time. if it spans the threshold, max will be greater than 1,\n *                      but min is always 0-1\n * @param loopLength\n */\nfunction windowPosition(loopTime, propWindow) {\n    var offset = (loopTime - propWindow.min + 1) % 1;\n    if (offset > propWindow.max - propWindow.min)\n        return null;\n    if (loopTime < propWindow.min) {\n        return loopTime + 1;\n    }\n    else {\n        return loopTime;\n    }\n}\nexports.windowPosition = windowPosition;\n","\nexport function kick(audioContext: AudioContext, start: number) {\n\n    var osc = audioContext.createOscillator();\n    var osc2 = audioContext.createOscillator();\n    var gainOsc = audioContext.createGain();\n    var gainOsc2 = audioContext.createGain();\n\n    osc.type = \"triangle\";\n    osc2.type = \"sine\";\n\n    gainOsc.gain.setValueAtTime(1, start);\n    gainOsc.gain.exponentialRampToValueAtTime(0.001, start + 0.5);\n    \n\n    gainOsc2.gain.setValueAtTime(1, start);\n    gainOsc2.gain.exponentialRampToValueAtTime(0.001, start + 0.5);\n  \n\n    osc.frequency.setValueAtTime(120, start);\n    osc.frequency.exponentialRampToValueAtTime(0.001, start + 0.5);\n\n    osc2.frequency.setValueAtTime(50, start);\n    osc2.frequency.exponentialRampToValueAtTime(0.001, start + 0.5);\n\n    osc.connect(gainOsc);\n    osc2.connect(gainOsc2);\n    gainOsc2.connect(audioContext.destination);\n    gainOsc.connect(audioContext.destination);\n    gainOsc.connect(audioContext.destination);\n    gainOsc2.connect(audioContext.destination);\n\n    osc.start(start);\n    osc2.start(start);\n\n    osc.stop(start + 0.5);\n    osc2.stop(start + 0.5);\n\n};\n\nexport function snare(audioContext: AudioContext, start: number) {\n\n    var osc3 = audioContext.createOscillator();\n    var gainOsc3 = audioContext.createGain();\n\n    var filterGain = audioContext.createGain();\n\n    filterGain.gain.setValueAtTime(1, start);\n    filterGain.gain.exponentialRampToValueAtTime(0.01, start + 0.2);\n\n    osc3.type = \"triangle\";\n    osc3.frequency.value = 100;\n    gainOsc3.gain.value = 0;\n\n    gainOsc3.gain.setValueAtTime(0, start);\n    gainOsc3.gain.exponentialRampToValueAtTime(0.01, start + 0.1);\n\n    osc3.connect(gainOsc3);\n    gainOsc3.connect(audioContext.destination);\n\n    osc3.start(start);\n    osc3.stop(start + 0.2);\n\n    var node = audioContext.createBufferSource(),\n        buffer = audioContext.createBuffer(1, 4096, audioContext.sampleRate),\n        data = buffer.getChannelData(0);\n\n    var filter = audioContext.createBiquadFilter();\n    filter.type = \"highpass\";\n    filter.frequency.setValueAtTime(100, start);\n    filter.frequency.linearRampToValueAtTime(1000, start + 0.2);\n\n\n    for (var i = 0; i < 4096; i++) {\n        data[i] = Math.random();\n    }\n    node.buffer = buffer;\n    node.loop = true;\n    node.connect(filter);\n    filter.connect(filterGain);\n    filterGain.connect(audioContext.destination);\n    node.start(start);\n    node.stop(start + 0.2);\n\n};\n\n\nexport function hihat(audioContext: AudioContext, start: number) {\n\n    var gainOsc4 = audioContext.createGain();\n    var fundamental = 40;\n    var ratios = [2, 3, 4.16, 5.43, 6.79, 8.21];\n\n    var bandpass = audioContext.createBiquadFilter();\n    bandpass.type = \"bandpass\";\n    bandpass.frequency.value = 10000;\n\n    var highpass = audioContext.createBiquadFilter();\n    highpass.type = \"highpass\";\n    highpass.frequency.value = 7000;\n\n\n    ratios.forEach(function(ratio) {\n\n        var osc4 = audioContext.createOscillator();\n        osc4.type = \"square\";\n        osc4.frequency.value = fundamental * ratio;\n        osc4.connect(bandpass);\n\n        osc4.start(start);\n        osc4.stop(start + 0.05);\n        \n    });\n\n    gainOsc4.gain.setValueAtTime(1, start);\n    gainOsc4.gain.exponentialRampToValueAtTime(0.01, start + 0.05);\n    \n    bandpass.connect(highpass);\n    highpass.connect(gainOsc4);\n    gainOsc4.connect(audioContext.destination);\n};","import React from 'react';\nimport './App.css';\n\nimport { MultiNoteLanes } from '@musicenviro/ui-elements';\nimport { kick, snare, hihat } from './drumSynth';\nimport { Scheduler, ILoopNote } from './Scheduler/Scheduler';\nimport { MessageClient } from '@geof/socket-messaging';\nimport { IMessage, INoteContent } from './@types';\nimport { IPoint } from '@musicenviro/base';\n\nimport Cursor from './resources/cursor_PNG99.png';\nimport { ReactFacebookLoginInfo } from 'react-facebook-login';\n\n// const testLoop = [\n// \t{ data: 1, loopTime: 0 },\n// \t{ data: 1, loopTime: 0.5 },\n// \t{ data: 1, loopTime: 0.875 },\n// ];\n\nconst nodeDropletIP = '167.172.3.7';\nconst local = false;\nconst serverURL = local ? 'ws://localhost:8080' : `ws://${nodeDropletIP}/ws`;\n\ninterface IState {\n\totherMouse: IPoint;\n}\n\nclass App extends React.Component<{userInfo: {name: string}}, IState> {\n\t\n\tscheduler = new Scheduler<number>();\n\tac!: AudioContext;\n\tuser = 'user' + Math.floor(Math.random() * 10000);\n\tmultiLane = React.createRef<MultiNoteLanes>();\n\n\tsubLoops: ILoopNote<number>[][] = [[], [], [], []];\n\n\tclient = new MessageClient<IMessage>(serverURL);\n\n\tconstructor(props: {userInfo: {name: string}}) {\n\t\tsuper(props);\n\n\t\tthis.state = {\n\t\t\totherMouse: { x: -10, y: -10 },\n\t\t};\n\n\t\t// this.scheduler.setLoop(testLoop);\n\n\t\tthis.scheduler.onSchedule((notes) =>\n\t\t\tnotes.forEach((note) => {\n\t\t\t\tconst fn = [hihat, hihat, snare, kick][note.data];\n\t\t\t\tfn(this.ac, note.audioContextTime);\n\t\t\t}),\n\t\t);\n\n\t\tthis.client.onMessage((message) => this.handleServerMessage(message));\n\n\t\tthis.client.onConnected(() => {\n\t\t\tsetInterval(() => this.reportMousePosition(), 100);\n\t\t});\n\t}\n\n\tstartAudio() {\n\t\tif (this.ac) {\n\t\t\tthis.ac.resume();\n\t\t} else {\n\t\t\tthis.ac = new AudioContext();\n\t\t\tthis.scheduler.setAudioContext(this.ac);\n\t\t\tthis.scheduler.start();\n\t\t}\n\t}\n\n\tstopAudio() {\n\t\tthis.ac && this.ac.suspend();\n\t}\n\n\thandleNoteChange(instr: number, notes: number[], broadcast: boolean = true) {\n\t\tif (broadcast) {\n\t\t\tconst diff = getDiff(\n\t\t\t\tthis.subLoops[instr].map((note) => note.loopTime),\n\t\t\t\tnotes,\n\t\t\t);\n\n\t\t\tdiff.add.forEach((n) =>\n\t\t\t\tthis.client.send({\n\t\t\t\t\tuser: this.user,\n\t\t\t\t\ttype: 'NoteChange',\n\t\t\t\t\tcontent: {\n\t\t\t\t\t\tsequence: 0, // not implemented\n\t\t\t\t\t\taction: 'Add',\n\t\t\t\t\t\tinstrument: instr,\n\t\t\t\t\t\tloopTime: n,\n\t\t\t\t\t},\n\t\t\t\t}),\n\t\t\t);\n\n\t\t\tdiff.delete.forEach((n) =>\n\t\t\t\tthis.client.send({\n\t\t\t\t\tuser: this.user,\n\t\t\t\t\ttype: 'NoteChange',\n\t\t\t\t\tcontent: {\n\t\t\t\t\t\tsequence: 0, // not implemented\n\t\t\t\t\t\taction: 'Delete',\n\t\t\t\t\t\tinstrument: instr,\n\t\t\t\t\t\tloopTime: n,\n\t\t\t\t\t},\n\t\t\t\t}),\n\t\t\t);\n\t\t}\n\n\t\tthis.subLoops[instr] = notes.map((note) => ({\n\t\t\tdata: instr,\n\t\t\tloopTime: note,\n\t\t}));\n\n\t\tthis.scheduler.setLoop(([] as ILoopNote[]).concat(...this.subLoops));\n\t}\n\n\thandleServerMessage(message: IMessage) {\n\t\tif (message.user !== this.user) {\n\t\t\tswitch (message.type) {\n\t\t\t\tcase 'MousePosition':\n\t\t\t\t\tthis.setState({\n\t\t\t\t\t\totherMouse: message.content,\n\t\t\t\t\t});\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase 'NoteChange':\n\t\t\t\t\tconst change = message.content as INoteContent;\n\n\t\t\t\t\tconst newLoopTimes = applyDiff(\n\t\t\t\t\t\tthis.subLoops[change.instrument].map((note) => note.loopTime),\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tadd: change.action === 'Add' ? [change.loopTime] : [],\n\t\t\t\t\t\t\tdelete: change.action === 'Delete' ? [change.loopTime] : [],\n\t\t\t\t\t\t},\n\t\t\t\t\t);\n\n\t\t\t\t\tthis.multiLane.current?.setNotes(change.instrument, newLoopTimes);\n\n\t\t\t\t\tthis.subLoops[change.instrument] = newLoopTimes.map((loopTime) => ({\n\t\t\t\t\t\tdata: change.instrument,\n\t\t\t\t\t\tloopTime,\n\t\t\t\t\t}));\n\n\t\t\t\t\tthis.scheduler.setLoop(([] as ILoopNote[]).concat(...this.subLoops));\n\t\t\t\t\t\n\t\t\t\t\tbreak;\n\n\t\t\t\tdefault:\n\t\t\t}\n\t\t}\n\t}\n\n\tmousePosition: IPoint = { x: -10, y: -10 };\n\n\treportMousePosition() {\n\t\tthis.client.send({\n\t\t\tuser: this.user,\n\t\t\ttype: 'MousePosition',\n\t\t\tcontent: this.mousePosition,\n\t\t});\n\t}\n\n\thandleMouseMove(event: React.MouseEvent) {\n\t\tthis.mousePosition = { x: event.clientX, y: event.clientY };\n\t}\n\n\trender() {\n\t\treturn (\n\t\t\t<div className=\"App\" onMouseMove={(event) => this.handleMouseMove(event)}>\n\t\t\t\t><header>SYNCROJAM {this.props.userInfo.name}</header>\n\t\t\t\t<div id=\"main\">\n\t\t\t\t\t<MultiNoteLanes\n\t\t\t\t\t\tref={this.multiLane}\n\t\t\t\t\t\tonChange={(instr, notes) => {\n\t\t\t\t\t\t\tthis.handleNoteChange(instr, notes);\n\t\t\t\t\t\t}}\n\t\t\t\t\t/>\n\t\t\t\t\t<button onClick={() => this.startAudio()}>play</button>\n\t\t\t\t\t<button onClick={() => this.stopAudio()}>pause</button>\n\t\t\t\t</div>\n\t\t\t\t<img\n\t\t\t\t\tsrc={Cursor}\n\t\t\t\t\tid=\"otherguy\"\n\t\t\t\t\talt=\"\"\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\t// backgroundColor: 'blue',\n\t\t\t\t\t\topacity: 0.3,\n\t\t\t\t\t\tposition: 'fixed',\n\t\t\t\t\t\tleft: this.state.otherMouse.x,\n\t\t\t\t\t\ttop: this.state.otherMouse.y,\n\t\t\t\t\t\theight: 20,\n\t\t\t\t\t\twidth: 20,\n\t\t\t\t\t}}\n\t\t\t\t/>\n\t\t\t</div>\n\t\t);\n\t}\n}\n\nexport default App;\n\nfunction getDiff(prev: number[], curr: number[]) {\n\tconst addedNotes = curr.filter((n) => !prev.includes(n));\n\tconst deletedNotes = prev.filter((n) => !curr.includes(n));\n\n\treturn {\n\t\tadd: addedNotes,\n\t\tdelete: deletedNotes,\n\t};\n}\n\nfunction applyDiff(orig: number[], diff: { add: number[]; delete: number[] }): number[] {\n\tlet copy = orig.slice();\n\tcopy.push(...diff.add);\n\tcopy = copy.filter((n) => !diff.delete.includes(n));\n\n\treturn copy;\n}\n","import React from 'react';\nimport ReactDOM from 'react-dom';\nimport App from './App';\nimport { ReactFacebookLoginInfo } from 'react-facebook-login';\nimport { FacebookLoginButton } from './users/LoginButton';\n\n\n\nlet userInfo: {name: string} | null = {\n\tname: \"<login disabled>\"\n};\n\nReactDOM.render(\n\t<App userInfo={{name: userInfo.name as string}} />,\n\t// <div>\n\t// \t<FacebookLoginButton\n\t// \t\tcallback={(info: ReactFacebookLoginInfo) => {\n\t// \t\t\tReactDOM.render(<App userInfo={{name: info.name as string}} />, document.getElementById('root'));\n\t// \t\t}}\n\t// \t/>\n\t// </div>,\n\tdocument.getElementById('root'),\n);\n"],"sourceRoot":""}